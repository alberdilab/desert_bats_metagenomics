[["index.html", "AlberdiLab | Aizpurua et al. in prep Desert bats metagenomics Chapter 1 Introduction 1.1 Prepare the R environment", " AlberdiLab | Aizpurua et al. in prep Desert bats metagenomics Ostaizka Aizpurua1 Antton Alberdi2 Orly Razgour3 2024-04-15 Chapter 1 Introduction This webbook contains all the code used for the study on the comparison of 16S amplicon sequencing and genome-resolved metagenomics in desert bats. 1.1 Prepare the R environment 1.1.1 Environment To reproduce all the analyses locally, clone this repository in your computer using: RStudio &gt; New Project &gt; Version Control &gt; Git And indicating the following git repository: https://github.com/alberdilab/desert_bats_metagenomics.git Once the R project has been created, follow the instructions and code chunks shown in this webbook. 1.1.2 Libraries The following R packages are required for the data analysis. # Base library(R.utils) library(knitr) library(tidyverse) library(devtools) library(tinytable) library(rairtable) # For tree handling library(ape) library(phyloseq) library(phytools) # For plotting library(ggplot2) library(ggrepel) library(ggpubr) library(ggnewscale) library(gridExtra) library(ggtreeExtra) library(ggtree) library(ggh4x) # For statistics library(spaa) library(vegan) library(Rtsne) library(geiger) library(hilldiv2) library(distillR) library(ANCOMBC) library(lme4) University of Copenhagen, ostaizka.aizpurua@sund.ku.dk↩︎ University of Copenhagen, antton.alberdi@sund.ku.dk↩︎ University of Exeter, o.razgour@exeter.ac.uk↩︎ "],["prepare-data.html", "Chapter 2 Prepare data 2.1 Load data", " Chapter 2 Prepare data 2.1 Load data Load the original data files outputted by the bioinformatic pipeline. To be added "],["prepare-data-1.html", "Chapter 3 Prepare data 3.1 Load data 3.2 Create working objects 3.3 Prepare color scheme 3.4 Wrap working objects", " Chapter 3 Prepare data 3.1 Load data Load the original data files outputted by the bioinformatic pipeline. 3.1.1 Sample metadata sample_metadata &lt;- read_tsv(&quot;data/metagenomics/sample_metadata.tsv&quot;) 3.1.2 Read counts read_counts &lt;- read_tsv(&quot;data/metagenomics/read_counts.tsv&quot;) 3.1.3 Genome coverage genome_coverage &lt;- read_tsv(&quot;data/metagenomics/genome_coverage.tsv&quot;) 3.1.4 Genome taxonomy genome_taxonomy &lt;- read_tsv(&quot;data/metagenomics/genome_taxonomy.tsv&quot;) %&gt;% select(user_genome,classification) %&gt;% separate(classification, c(&quot;domain&quot;,&quot;phylum&quot;,&quot;class&quot;,&quot;order&quot;,&quot;family&quot;,&quot;genus&quot;,&quot;species&quot;), sep =&quot;;&quot;) %&gt;% rename(genome=1) %&gt;% mutate(genome = str_remove(genome, &quot;\\\\.fa$&quot;)) 3.1.5 Genome length genome_length &lt;- read_tsv(&quot;data/metagenomics/genome_length.tsv&quot;) 3.1.6 Genome metadata genome_metadata &lt;- inner_join(genome_taxonomy,genome_length,by=join_by(genome==genome)) 3.1.7 Genome tree genome_tree &lt;- read_tree(&quot;data/metagenomics/genome_tree.tre&quot;) genome_tree$tip.label &lt;- str_replace_all(genome_tree$tip.label,&quot;&#39;&quot;, &quot;&quot;) #remove single quotes in MAG names genome_tree$tip.label &lt;- str_remove(genome_tree$tip.label, &quot;\\\\.fa$&quot;) #remove .fa suffix genome_tree &lt;- keep.tip(genome_tree, tip=genome_taxonomy$genome) # keep only MAG tips 3.1.8 Genome annotations TO BE ADDED 3.1.9 Preprocessing statistics sample_preprocessing &lt;- read_tsv(&quot;data/metagenomics/preprocessing_stats.tsv&quot;) %&gt;% mutate(host_bases=host_reads*300) 3.2 Create working objects Transform the original data files into working objects for downstream analyses. 3.2.1 Filter reads by coverage min_coverage=0.3 read_counts_filt &lt;- genome_coverage %&gt;% mutate(across(where(is.numeric), ~ ifelse(. &gt; min_coverage, 1, 0))) %&gt;% mutate(across(-1, ~ . * read_counts[[cur_column()]])) 3.2.2 Transform reads into genome counts readlength=150 genome_counts &lt;- read_counts %&gt;% mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) )) readlength=150 genome_counts_filt &lt;- read_counts_filt %&gt;% mutate(across(where(is.numeric), ~ . / (genome_metadata$length / readlength) )) 3.2.3 Distill annotations into GIFTs #genome_gifts &lt;- distill(genome_annotations,GIFT_db,genomecol=2,annotcol=c(9,10,19), verbosity=F) 3.3 Prepare color scheme AlberdiLab projects use unified color schemes developed for the Earth Hologenome Initiative, to facilitate figure interpretation. phylum_colors &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% arrange(match(genome, genome_tree$tip.label)) %&gt;% select(phylum, colors) %&gt;% unique() %&gt;% arrange(phylum) %&gt;% pull(colors, name=phylum) 3.4 Wrap working objects All working objects are wrapped into a single Rdata object to facilitate downstream usage. save(sample_metadata, sample_preprocessing, genome_metadata, read_counts, genome_counts, genome_counts_filt, genome_tree, phylum_colors, file = &quot;data/data.Rdata&quot;) "],["data-statistics.html", "Chapter 4 Data statistics 4.1 Sequencing reads statistics 4.2 DNA fractions", " Chapter 4 Data statistics load(&quot;data/data.Rdata&quot;) 4.1 Sequencing reads statistics sample_preprocessing %&gt;% summarise(Total=sum(reads_post_filt * 150 / 1000000000) %&gt;% round(2), mean=mean(reads_post_filt * 150 / 1000000000) %&gt;% round(2), sd=sd(reads_post_filt * 150 / 1000000000) %&gt;% round(2)) %&gt;% unite(&quot;Average&quot;,mean, sd, sep = &quot; ± &quot;, remove = TRUE) %&gt;% tt() tinytable_42ta5h9ht7zq2ikhpxps .table td.tinytable_css_c0ift0gioht7rhhdhf8t, .table th.tinytable_css_c0ift0gioht7rhhdhf8t { border-bottom: solid 0.1em #d3d8dc; } Total Average 712.18 7.83 ± 8.08 4.2 DNA fractions sequence_fractions &lt;- read_counts %&gt;% pivot_longer(-genome, names_to = &quot;sample&quot;, values_to = &quot;value&quot;) %&gt;% group_by(sample) %&gt;% summarise(mags = sum(value)) %&gt;% left_join(sample_preprocessing, by = join_by(sample == sample)) %&gt;% select(sample,mags,bases_pre_filt,bases_post_filt,host_bases,metagenomic_bases) %&gt;% mutate(mags_bases = mags*150) %&gt;% mutate(lowqual_bases = bases_pre_filt - bases_post_filt) %&gt;% mutate(unmapped_bases = metagenomic_bases - mags_bases) %&gt;% mutate(unmapped_bases = ifelse(unmapped_bases &lt; 0, 0, unmapped_bases)) %&gt;% select(sample, lowqual_bases, host_bases, unmapped_bases, mags_bases) sequence_fractions %&gt;% mutate_at(vars(-sample), ~./1000000000) %&gt;% rename(&quot;Sample&quot;=1, &quot;Low quality&quot;=2, &quot;Mapped to host&quot;=3, &quot;Unmapped&quot;=4, &quot;Mapped to MAGs&quot;=5) %&gt;% tt() tinytable_mdkevdeimv61kkh0n76t .table td.tinytable_css_vsack6gwiljaesly40ec, .table th.tinytable_css_vsack6gwiljaesly40ec { border-bottom: solid 0.1em #d3d8dc; } Sample Low quality Mapped to host Unmapped Mapped to MAGs E01 1.9123757 1.7193909 0.50379365 1.83467325 E02 0.4353280 4.2158016 0.99338589 0.02671065 E03 1.3042313 1.7994078 6.42222236 0.01078875 E16 0.4224530 0.1025580 0.20197846 4.93816200 E18 4.7850204 6.9637290 24.05986617 0.52864665 E21 1.0156349 2.6368389 0.90981533 0.10217775 E24 3.7280695 1.1110971 23.81060939 2.34316305 E25 1.5376473 7.9804608 6.00871944 0.85221990 E27 0.4230030 0.0911577 1.95160083 0.44069160 E28 1.6079642 1.0844487 4.47911541 0.19568490 E30 1.7928992 1.4413299 4.00947792 5.12918235 E31 0.6816818 0.0320553 0.50570530 2.84763450 E34 2.1948529 0.8249310 11.67502744 2.54218275 E38 0.9838001 4.3969737 1.28190071 0.01802595 E43 0.4955380 2.8185273 0.82331661 0.00793485 E44 0.4234418 5.9270472 0.44183940 0.24959295 E45 1.5173952 0.8510214 1.95118882 0.84886650 E48 2.3197861 1.9469865 7.44564809 5.90044110 E56 0.5108719 0.0847401 1.09609707 1.82499015 E58 0.4880990 2.1264312 1.36506017 0.11759265 H04 2.5008506 27.4835352 13.14400663 0.03507165 H06 0.2841785 2.0398764 1.46660757 0.01427955 H07 1.4500404 10.9416210 3.39146197 0.01941135 H08 0.5011987 0.2131668 0.57356153 0.45570180 H09 1.2653958 10.8166410 7.00507483 0.15877860 H10 0.7942211 1.3782558 4.03545973 0.11882340 H12 2.5813911 8.4009948 4.51254046 0.84020835 H15 0.1917405 1.5658842 0.74185414 0.00826125 H16 2.1486462 4.0113864 9.56424671 3.69521370 H19 0.5557962 4.2411288 2.50314959 0.02286150 H20 0.9677842 4.3890999 3.78083553 0.07778835 H23 0.9420728 3.9595926 1.30102424 0.29551170 H25 1.0738812 7.7087100 3.42255644 0.68422815 H30 0.4902154 1.3423326 0.75352358 2.29694205 H31 1.8416387 9.7206468 4.43631049 0.48033270 H32 0.5427161 5.8415880 1.38975295 0.06290070 H34 1.3188004 12.4245048 5.12752821 0.02616405 H37 2.5737627 27.8754720 9.15837446 0.25084785 H39 0.2938515 2.4124689 0.75581958 0.02116935 H40 1.1315544 3.8592006 5.83728129 0.42791340 H43 0.7161526 6.3701718 2.50320009 0.03324300 H45 0.9215094 1.5407343 3.94772969 0.81685470 H47 0.9581476 5.6254728 2.15816743 0.32372385 P01 0.5733407 1.8086574 1.33450269 0.76149270 P05 1.1668645 9.3271338 0.63288528 0.36958890 P09 0.7574713 7.1642826 0.52521364 0.04058895 P14 0.5034011 3.8678286 0.03866504 0.64239540 P20 0.7666679 2.0253963 0.68358450 0.54081750 P25 0.2950900 4.5486294 0.50927300 0.38403045 P28 4.4616492 30.8235540 17.16905293 1.83789930 P33 3.3222731 33.2508960 7.86558092 0.43485525 P34 0.3459813 0.8618043 1.84351514 0.01439085 P36 1.2281449 10.5844332 0.28646419 0.71007735 P41 1.6479428 25.4247288 3.56446783 1.35787020 P43 3.4204299 3.2932512 7.78711290 13.30940625 P45 1.6790221 2.9649723 5.42286382 0.12008145 P47 0.4775963 2.8718187 1.06401988 0.80290395 P48 3.0192702 0.9945204 17.82268997 6.15753405 P49 0.8859881 15.7503030 0.32349316 0.16673670 P51 1.8101944 8.2580928 3.46629537 2.64862665 P53 1.5688483 24.5797020 2.14349384 0.12960855 P56 0.9749002 12.3956724 0.19719518 1.01352285 P58 0.7963638 6.4119048 1.11305236 0.07796910 P60 2.3930517 33.2359848 8.57518064 0.20491080 P64 0.2656280 0.3023889 1.17634560 0.47208750 P65 0.4114934 0.2113239 0.89754587 1.90757895 P67 1.7026024 17.3557032 0.62786285 2.02223145 P69 0.4073834 1.8827937 1.76632754 0.23484960 P72 0.2702016 3.9134910 0.57524887 0.20525790 P75 1.4392490 2.6274414 6.26632261 1.62440925 P78 0.9165986 2.0786076 1.22668730 0.48372150 P79 1.7376207 12.1993284 7.73575004 1.52807535 sequence_fractions %&gt;% pivot_longer(!sample, names_to = &quot;fraction&quot;, values_to = &quot;value&quot;) %&gt;% mutate(value = value / 1000000000) %&gt;% mutate(fraction = factor(fraction, levels = c(&quot;lowqual_bases&quot;,&quot;host_bases&quot;,&quot;unmapped_bases&quot;,&quot;mags_bases&quot;))) %&gt;% ggplot(., aes(x = sample, y = value, fill=fraction)) + geom_bar(position=&quot;stack&quot;, stat = &quot;identity&quot;) + scale_fill_manual(name=&quot;Sequence type&quot;, breaks=c(&quot;lowqual_bases&quot;,&quot;host_bases&quot;,&quot;unmapped_bases&quot;,&quot;mags_bases&quot;), labels=c(&quot;Low quality&quot;,&quot;Mapped to host&quot;,&quot;Unmapped&quot;,&quot;Mapped to MAGs&quot;), values=c(&quot;#CCCCCC&quot;, &quot;#bcdee1&quot;, &quot;#d8b8a3&quot;,&quot;#93655c&quot;))+ labs(x = &quot;Samples&quot;, y = &quot;Amount of data (GB)&quot;) + theme_classic() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size=6),legend.position = &quot;bottom&quot;) tinytable_wagg0i30bdu3sucwednl .table td.tinytable_css_oek39pvgmdtdsl836l2k, .table th.tinytable_css_oek39pvgmdtdsl836l2k { border-bottom: solid 0.1em #d3d8dc; } species mean_host_perc sd_host_perc max_host_perc min_host_perc Eb 24.0105851 26.0487087 77.523636 0.39599794 Ha 36.4671066 15.3892853 58.926064 6.53771139 Pk 56.5200310 29.2493571 92.136483 1.81265533 NA 0.5625856 0.4379119 1.079399 0.02651141 "],["mag-catalogue.html", "Chapter 5 MAG catalogue 5.1 Genome phylogeny", " Chapter 5 MAG catalogue load(&quot;data/data.Rdata&quot;) 5.1 Genome phylogeny # Generate the phylum color heatmap phylum_heatmap &lt;- read_tsv(&quot;https://raw.githubusercontent.com/earthhologenome/EHI_taxonomy_colour/main/ehi_phylum_colors.tsv&quot;) %&gt;% right_join(genome_metadata, by=join_by(phylum == phylum)) %&gt;% arrange(match(genome, genome_tree$tip.label)) %&gt;% select(genome,phylum) %&gt;% mutate(phylum = factor(phylum, levels = unique(phylum))) %&gt;% column_to_rownames(var = &quot;genome&quot;) # Generate basal tree circular_tree &lt;- force.ultrametric(genome_tree, method=&quot;extend&quot;) %&gt;% # extend to ultrametric for the sake of visualisation ggtree(., layout=&quot;fan&quot;, open.angle=10, size=0.5) *************************************************************** * Note: * * force.ultrametric does not include a formal method to * * ultrametricize a tree &amp; should only be used to coerce * * a phylogeny that fails is.ultrametric due to rounding -- * * not as a substitute for formal rate-smoothing methods. * *************************************************************** # Add phylum ring circular_tree &lt;- gheatmap(circular_tree, phylum_heatmap, offset=0.55, width=0.1, colnames=FALSE) + scale_fill_manual(values=phylum_colors) + geom_tiplab2(size=1, hjust=-0.1) + theme(legend.position = &quot;none&quot;, plot.margin = margin(0, 0, 0, 0), panel.margin = margin(0, 0, 0, 0)) # Flush color scale to enable a new color scheme in the next ring circular_tree &lt;- circular_tree + new_scale_fill() # Add genome-size ring circular_tree &lt;- circular_tree + new_scale_fill() + scale_fill_manual(values = &quot;#cccccc&quot;) + geom_fruit( data=genome_metadata, geom=geom_bar, mapping = aes(x=length, y=genome), offset = 0.05, orientation=&quot;y&quot;, stat=&quot;identity&quot;) # Add text circular_tree &lt;- circular_tree + annotate(&#39;text&#39;, x=2.7, y=0, label=&#39; Phylum&#39;, family=&#39;arial&#39;, size=3.5) + annotate(&#39;text&#39;, x=3.5, y=0, label=&#39; Genome size&#39;, family=&#39;arial&#39;, size=3.5) #Plot circular tree circular_tree %&gt;% open_tree(30) %&gt;% rotate_tree(90) "],["404.html", "Page not found", " Page not found The page you requested cannot be found (perhaps it was moved or renamed). You may want to try searching to find the page's new location, or use the table of contents to find the page you are looking for. "]]
